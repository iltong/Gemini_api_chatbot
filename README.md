# Gemini Chat Assistant v6 (모듈화)

개선된 모듈화된 구조로 재구성된 Gemini AI 챗봇 애플리케이션입니다.

## 📁 프로젝트 구조

```
main_ver6/
├── main.py                    # 메인 실행 파일
├── README.md                  # 프로젝트 설명서
├── __init__.py               # 패키지 초기화
├── config/                   # 설정 관련 모듈
│   ├── __init__.py
│   └── settings.py          # 앱 설정 및 구성
├── core/                    # 핵심 로직 모듈
│   ├── __init__.py
│   ├── gemini_client.py     # Gemini API 클라이언트
│   └── chat_application.py  # 메인 애플리케이션 클래스
├── ui/                      # UI 컴포넌트 모듈
│   ├── __init__.py
│   ├── chat_display.py      # 채팅 디스플레이 컴포넌트
│   └── settings_dialog.py   # 설정 대화상자
└── utils/                   # 유틸리티 모듈
    ├── __init__.py
    ├── markdown_parser_v2.py  # 고급 마크다운 렌더링 (v2)
    ├── image_handler.py      # 다중 이미지 처리
    ├── file_handler.py       # 파일 업로드 처리
    └── conversation_manager.py # 대화 저장/불러오기
```

## 🚀 실행 방법

### Windows에서 쉬운 실행 (권장)
```cmd
# 프로젝트 폴더에서 배치 파일 실행
run.bat
```

**🏃‍♀️ 빠른 시작의 특징:**
- **첫 실행**: 자동 환경 설정 (가상환경 생성, 패키지 설치)
- **이후 실행**: 1-2초 내 즉시 시작 (스마트 캐싱 시스템)
- **자동 복구**: 환경 손상 시 자동으로 재설정

### 수동 실행 (개발자용)
```bash
# 가상환경 활성화 (Windows)
venv\Scripts\activate

# 또는 직접 실행
venv\Scripts\python.exe main.py
```

## ✨ 주요 기능

### 1. 🌊 실시간 스트리밍 응답
- AI 응답이 실시간으로 표시됩니다
- ⏹️ 중단 버튼으로 언제든 응답을 중단할 수 있습니다
- 스트리밍 완료 후 마크다운 렌더링으로 최종 정리됩니다

### 2. ⚙️ 고급 설정
- **생성 파라미터 커스터마이징**:
  - `max_output_tokens`: 1~32,768 (응답 길이)
  - `temperature`: 0.0~2.0 (창의성)
  - `top_p`: 0.0~1.0 (다양성)  
  - `top_k`: 1~100 (후보 수)
  - `presence_penalty`: -2.0~2.0 (주제 다양성)
  - `frequency_penalty`: -2.0~2.0 (반복 방지)

### 3. 🎭 시스템 프롬프트 설정
- AI의 페르소나를 설정할 수 있습니다
- 프리셋 제공: 기본, 번역사, 코딩 도우미, 학습 도우미
- 커스텀 시스템 프롬프트 작성 가능

### 4. 📊 API 사용량 모니터링
- 일별 요청 횟수 추적
- 토큰 사용량 실시간 카운트
- 대략적인 비용 추정 (Pro/Flash 모델별)

### 5. 📝 고급 마크다운 렌더링
- **완전 새로운 토큰 기반 파서**: 정확하고 안정적인 마크다운 처리
- **접기/펼치기 코드 블록**: 
  - 🔽 기본적으로 접힌 상태로 표시 (공간 절약)
  - 📊 코드 언어와 줄 수 표시
  - 📋 원클릭 복사 기능
  - 📜 긴 코드는 스크롤 지원
- **향상된 텍스트 스타일링**: 볼드, 이탤릭, 인라인 코드 완벽 지원
- **리스트와 인용구**: 깔끔한 시각적 표현
- **하늘색 헤더**: 가독성 높은 헤더 스타일링

### 6. 🔄 향상된 오류 처리
- 자동 재시도 로직 (최대 3회)
- 네트워크 오류 시 지수적 백오프
- 상세한 오류 메시지 및 해결 방법 제시

### 7. 🖼️ 다중 이미지 & 파일 지원
- **다중 이미지 업로드**: 최대 4개 이미지 동시 첨부 가능
- **통합 타일 시스템**: 입력창 위에 이미지와 파일을 타일 형태로 미리보기
- **호버 미리보기**: 
  - 🖼️ 이미지: 마우스 올리면 300x300 크게 미리보기
  - 📄 파일: 마우스 올리면 파일명 툴팁 표시
- **드래그 앤 드롭**: 이미지와 파일을 창에 끌어다 놓기로 간편 첨부
- **클립보드 지원**: Ctrl+V로 복사한 이미지 바로 첨부
- **클릭 삭제**: 타일 클릭으로 개별 파일/이미지 삭제
- **파일 형식**: 40+ 확장자 지원 (코드, 문서, 압축파일 등)
- **스마트 아이콘**: 파일 확장자별 적절한 이모지 아이콘 표시

### 8. 💾 대화 관리
- 대화 저장/불러오기 (JSON 형식)
- 설정 정보까지 함께 저장
- 대화 맥락 유지
- 다중 이미지 정보 포함 저장

## 🛠️ 기술적 개선사항

### 🏗️ 모듈화 구조
- **관심사 분리**: 각 기능을 독립적인 모듈로 분리
- **재사용성**: 컴포넌트 재사용 가능
- **유지보수성**: 코드 수정 및 확장 용이
- **테스트 용이성**: 각 모듈별 독립적 테스트 가능

### 🎯 클래스 설계
- `AppConfig`: 모든 설정을 중앙 관리
- `GeminiClient`: API 통신 전담
- `ChatDisplay`: UI 디스플레이 전담
- `ImageHandler`: 다중 이미지 처리 전담
- `FileHandler`: 파일 업로드 및 처리 전담
- `ConversationManager`: 대화 저장/불러오기 전담

### ⚡ 성능 최적화
- **스마트 실행 시스템**: 
  - 첫 실행: 자동 환경 설정 (20-30초)
  - 이후 실행: 빠른 시작 모드 (1-2초)
  - 패키지 설치 상태 실시간 검증
- **효율적인 마크다운 파싱**: 
  - 토큰 기반 파서로 성능 향상
  - 메모리 효율적인 렌더링
  - 접기/펼치기로 UI 반응성 개선

## 📋 요구사항

- Python 3.7+
- tkinter (대부분 Python에 기본 포함)
- google-generativeai
- python-dotenv
- Pillow (PIL)

## 🔧 설정

1. `.env` 파일에 Gemini API 키 설정:
```
GEMINI_API_KEY=your_api_key_here
```

2. 또는 프로그램 실행 시 API 키 입력

## 📝 사용법

1. **빠른 시작**: `run.bat` 실행 (Windows에서 자동 환경 설정)
2. **모델 선택**: 상단에서 Gemini 2.5 Pro 또는 Flash 선택
3. **설정 조정**: ⚙️ 설정 버튼으로 고급 설정 접근
4. **대화하기**: 
   - Enter: 메시지 전송
   - Ctrl/Shift + Enter: 줄바꿈
5. **첨부파일**: 
   - 🖼️ 이미지 버튼으로 다중 이미지 첨부 (최대 4개)
   - 📄 파일 버튼으로 코드/문서 파일 첨부
   - 드래그 앤 드롭으로 간편 첨부
   - Ctrl+V로 클립보드 이미지 첨부
   - 타일 형태로 미리보기 및 호버 확대
   - 개별 타일 클릭으로 삭제
6. **코드 블록 활용**:
   - ▶️ 코드 블록 헤더 클릭으로 접기/펼치기
   - 📋 복사 버튼으로 코드 원클릭 복사
   - 📜 긴 코드는 스크롤로 확인
7. **응답 제어**: ⏹️ 중단 버튼으로 응답 중단
8. **대화 관리**: 💾 저장, 📂 불러오기, 🆕 새로시작

## 🎯 v6의 장점

- **⚡ 초고속 시작**: 두 번째 실행부터 1-2초 내 즉시 시작
- **🔧 확장성**: 새로운 기능 추가가 용이한 모듈 구조
- **🛡️ 안정성**: 모듈별 독립적 동작으로 오류 격리
- **📖 가독성**: 
  - 접기/펼치기 코드 블록으로 깔끔한 화면
  - 향상된 마크다운 렌더링으로 보기 좋은 텍스트
- **🚀 성능**: 각 모듈이 최적화된 역할만 수행
- **👥 협업**: 여러 개발자가 동시에 작업 가능

## 📋 개발 노트

### 파일 업로드 기능 추가 가능성 검토
- **현재 상태**: 이미지 업로드만 지원 (`utils/image_handler.py`)
- **Gemini API**: 텍스트 파일 업로드 지원 확인됨 (코드, HTML, 문서 등)
- **기존 인프라**: 드래그앤드롭 기능이 이미 구현되어 있어 확장 용이
- **구현 방안**:
  - `FileHandler` 클래스 생성 (이미지와 분리)
  - 지원 확장자: `.py`, `.js`, `.html`, `.css`, `.txt`, `.md`, `.json`, `.xml` 등
  - 파일 내용을 텍스트로 읽어 Gemini API에 전송
  - UI에 파일 업로드 버튼과 미리보기 추가
- **구현 완료**: 파일 업로드 기능이 성공적으로 추가됨 ✅
  - `FileHandler` 클래스 생성 및 40+ 파일 확장자 지원
  - 📄 파일 버튼 추가 (이미지 버튼 옆)
  - 드래그앤드롭으로 파일 업로드 지원
  - 파일 미리보기 및 정보 표시
  - 최대 5MB 파일 크기 제한
  - 자동 인코딩 감지 (UTF-8, CP949, EUC-KR 등)

### 마크다운 렌더링 시스템 완전 재구축
- **토큰 기반 파서 구현 완료**: 안정적이고 확장 가능한 마크다운 시스템 ✅
  - **TokenType & Token**: 모든 마크다운 요소를 토큰으로 분류
  - **MarkdownTokenizer**: 정규식 기반 토큰화 엔진
  - **MarkdownStyleManager**: 일관된 스타일 관리 시스템
  - **MarkdownRenderer**: 통합된 렌더링 엔진
- **접기/펼치기 코드 블록**: 실용적인 코드 표시 시스템 ✅
  - **기본 접힌 상태**: 공간 절약을 위한 스마트 UI
  - **헤더 정보**: 언어명, 줄 수, 접기/펼기 아이콘 표시
  - **원클릭 토글**: 헤더 영역 클릭으로 쉬운 조작
  - **복사 기능**: 접힌 상태에서도 전체 코드 복사 가능
  - **스크롤 지원**: 긴 코드의 세로/가로 스크롤
  - **최적화된 높이**: 최대 20줄까지 자동 높이 조정

### 채팅 UI 개선
- **첨부파일 표시 개선 완료**: 파일과 이미지 정보 모두 표시 ✅
  - **📄 파일 정보**: 업로드한 파일명과 타입 표시 (보라색)
  - **🖼️ 이미지 정보**: 이미지 파일 정보 표시 (주황색) 
  - **이미지 크기 증가**: 채팅창 미리보기 450x300으로 확대
  - **동시 첨부 지원**: 이미지 + 파일 동시 첨부 시 모두 표시
  - **구분된 스타일**: 각 첨부 타입별로 다른 색상과 아이콘 사용

### 🎯 다중 이미지 타일 시스템 구현 (최신)
- **통합 첨부파일 타일 시스템 완료**: 혁신적인 UI/UX 개선 ✅
  - **🔄 입력창 위 타일 배치**: 기존 팝업 방식을 타일 형태로 완전 개편
  - **🖼️ 다중 이미지 지원**: 최대 4개 이미지를 80x80 타일로 미리보기
  - **📄 파일과 이미지 통합**: 하나의 타일 시스템에서 모든 첨부파일 관리
  - **✨ 호버 미리보기**: 
    - 이미지: 300x300 크기로 확대 미리보기 + 파일명 표시
    - 파일: 간단한 파일명 툴팁 표시
  - **🎯 클릭 삭제**: 각 타일 클릭으로 개별 첨부파일 삭제 가능
  - **📱 반응형 레이아웃**: 첨부파일 없을 때 자동 숨김, 있을 때만 표시
  - **🔧 완벽한 위치 제어**: 입력창 바로 위 고정 위치, 레이아웃 충돌 해결
  - **🎨 파일 타입별 아이콘**: 확장자에 따른 직관적인 이모지 아이콘 매핑
  - **⚡ 드래그앤드롭 통합**: 기존 D&D 기능과 새 타일 시스템 완벽 연동
  - **🔄 순서 무관 첨부**: 파일 먼저 첨부하거나 이미지 먼저 첨부해도 정상 동작

## 📈 최신 업데이트 (v6.1)

### 🎯 주요 신규 기능
- **🖼️ 다중 이미지 타일 시스템**: 혁신적인 첨부파일 UI/UX 완전 개편
- **📄 통합 첨부파일 관리**: 이미지와 파일을 하나의 타일 시스템으로 통합
- **✨ 호버 미리보기**: 직관적인 마우스 오버 미리보기 시스템
- **🎨 스마트 파일 아이콘**: 40+ 확장자별 맞춤 이모지 아이콘

### 🔧 기술적 개선
- **레이아웃 엔진 최적화**: 입력창 위치 고정 및 충돌 해결
- **이벤트 바인딩 시스템**: 안정적인 호버 및 클릭 이벤트 처리
- **메모리 관리 개선**: 이미지 참조 최적화 및 가비지 컬렉션 방지
- **에러 핸들링 강화**: 파일/이미지 로드 실패 시 graceful degradation

### 🐛 버그 수정
- 파일 먼저 첨부 시 발생하던 시스템 오류 해결
- 파일과 이미지 동시 첨부 시 호버 기능 미작동 문제 수정
- 타일 위치 이동 문제 및 레이아웃 찌그러짐 완전 해결
- tkinter grid 파라미터 호환성 문제 수정 (`-col` → `column=`)

### 💡 사용자 경험 개선
- 입력창 위 고정 위치로 일관된 첨부파일 미리보기
- 클릭 한 번으로 개별 파일 삭제 가능
- 첨부파일 없을 때 자동 숨김으로 깔끔한 UI
- 파일 타입별 직관적인 아이콘으로 가독성 향상